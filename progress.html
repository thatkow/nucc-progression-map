<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>NUCC Progression Map</title>
  <script src="https://unpkg.com/vis-network@9.1.9/dist/vis-network.min.js"></script>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #split-container {
      display: flex; height: 100%; width: 100%;
    }
    #graph-div {
      flex: 2; border-right: 1px solid #ccc;
    }
    #info-container {
      flex: 1; display: flex; flex-direction: column; height: 100%;
    }
    #info-panel {
      flex: 2; padding: 15px; overflow-y: auto; background-color: #f9f9f9;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    #info-text {
      flex: 1 1 auto; overflow-y: auto;
    }
    #image-wrapper {
      flex: 0 0 auto; display: flex; justify-content: center; align-items: center; height: 50vh;
    }
    img.preview {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      border-radius: 4px;
      border: 1px solid #bbb;
      background-color: #fff;
    }
    #user-panel {
      flex: 0 0 140px; padding: 15px; border-top: 1px solid #ccc; background-color: #fff;
    }
    select {
      width: 100%; font-size: 14px; padding: 6px; margin-top: 6px;
    }
  </style>
</head>
<body>
<div id="split-container">
  <div id="graph-div"></div>
  <div id="info-container">
    <div id="info-panel">
      <div id="info-text">
        <h3>Select a node</h3>
        <p>Loading definitions and user progressâ€¦</p>
      </div>
      <div id="image-wrapper"></div>
    </div>
    <div id="user-panel">
      <b>Show progress for:</b><br>
      <select id="user-select">
        <option value="">â€” Loading users â€”</option>
      </select>
    </div>
  </div>
</div>

<script>
async function loadDefinition() {
  const cors = "https://corsproxy.io/?";
  const defURL = cors + encodeURIComponent("https://drive.google.com/uc?export=download&id=1ioqhEoWUF4kuke9kuyPTJ9iPsuHIbHzo");
  const resp = await fetch(defURL);
  if (!resp.ok) throw new Error("Failed to load definition.json");
  return await resp.json();
}

async function loadUserProgress() {
  const cors = "https://corsproxy.io/?";
  const csvURL = cors + encodeURIComponent("https://drive.google.com/uc?export=download&id=1P34v8R85wMv0cyV3GOggt7yr5ke6tWl-");
  const resp = await fetch(csvURL);
  if (!resp.ok) throw new Error("Failed to load user_progress.csv");
  const csvText = await resp.text();
  const lines = csvText.trim().split(/\r?\n/);
  const headers = lines[0].split(",");
  const up = {};
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(",");
    const user = parts[0].trim();
    up[user] = {};
    for (let j = 1; j < headers.length; j++) {
      const node = headers[j].trim();
      const val = parts[j]?.trim();
      if (val) up[user][node] = val;
    }
  }
  return up;
}

async function main() {
  try {
    const [definition, userProgress] = await Promise.all([loadDefinition(), loadUserProgress()]);
    console.log("Loaded definition:", definition);
    console.log("Loaded user progress:", userProgress);

    const users = Object.keys(userProgress);
    const select = document.getElementById("user-select");
    select.innerHTML = `<option value="">â€” Select user â€”</option>` +
      users.map(u => `<option value="${u}">${u}</option>`).join("");

    const nodes = new vis.DataSet();
    const edges = new vis.DataSet();

    for (const node of definition.nodes) {
      const pos = (definition.layout && definition.layout[node.id]) || { x: 0, y: 0 };
      const imgPath = "images/" + encodeURIComponent(node.id) + ".png";
      nodes.add({
        id: node.id,
        label: node.id,
        title: node.id + "\nCategory: " + (node.category || "") + "\nSign-off: " + (node.signoff || ""),
        category: node.category,
        signoff: node.signoff,
        description: node.description,
        shape: "box",
        color: node.color,
        fixed: { x: true, y: true },
        x: pos.x,
        y: pos.y,
        imagefile: imgPath
      });
    }

    for (const e of definition.edges) {
      edges.add({ from: e.from, to: e.to, arrows: "to" });
    }

    const container = document.getElementById("graph-div");
    const data = { nodes, edges };
    const options = {
      physics: { enabled: false },
      interaction: {
        dragNodes: false,
        dragView: false,
        zoomView: true,
        selectable: true,
        multiselect: false,
        navigationButtons: false,
        keyboard: false
      },
      edges: {
        smooth: false,
        arrows: { to: { enabled: true, scaleFactor: 0.8 } },
        color: { color: "#333333" }
      },
      nodes: { borderWidth: 1, font: { face: "arial", size: 16 } }
    };
    const network = new vis.Network(container, data, options);

    const origColors = {};
    nodes.get().forEach(n => { origColors[n.id] = n.color; });

    network.on("click", params => {
      if (params.nodes.length === 0) return;
      const nodeId = params.nodes[0];
      const n = nodes.get(nodeId);
      const ip = userProgress;
      const compList = [];
      for (const [u, map] of Object.entries(ip)) {
        if (map[nodeId]) compList.push(`${u}: ${map[nodeId]}`);
      }
      const compHtml = compList.length ? compList.join("<br>") : "â€”";
      const imgTag = n.imagefile ? `<img src='${n.imagefile}' class='preview' alt='${n.label} image'>` : "";

      const textPanel = document.getElementById("info-text");
      const imagePanel = document.getElementById("image-wrapper");
      textPanel.innerHTML = `
        <h3>${n.label}</h3>
        <b>Category:</b> ${n.category || ""}<br>
        <b>Sign-off:</b> ${n.signoff || ""}<br><br>
        <div style="white-space:pre-wrap;">${n.description || ""}</div><br>
        <b>Completed:</b><br>${compHtml}
      `;
      imagePanel.innerHTML = imgTag;
    });

    select.addEventListener("change", () => {
      const user = select.value;
      nodes.get().forEach(n => {
        const orig = origColors[n.id] || "#cccccc";
        const completed = user && userProgress[user] && userProgress[user][n.id];
        const newColor = completed ? orig : "#dddddd";
        const newTitle = n.label + (completed ? `\nCompleted: ${userProgress[user][n.id]}` : "\nNot yet completed");
        nodes.update({ id: n.id, color: newColor, title: newTitle });
      });
    });

  } catch (err) {
    console.error("Error in main():", err);
    document.getElementById("info-text").textContent = "ðŸ“› Failed to load data.";
  }
}

window.addEventListener("load", main);
</script>

</body>
</html>
