<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NUCC Progression Map</title>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.css" rel="stylesheet" />
  <style>
  /* --- Base layout (desktop & landscape) --- */
  #split-container {
    display: flex;
    height: 100vh;
    width: 100%;
  }

  #graph-div {
    flex: 2;
    border-right: 1px solid #ccc;
    overflow: hidden;
  }

  #info-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  #info-panel {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f9f9f9;
  }

  #image-wrapper {
    flex: 0 0 auto;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 40vh;
  }

  img.preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border: 1px solid #bbb;
    border-radius: 4px;
    background-color: #fff;
  }

  #user-panel {
    flex: 0 0 40px;
    padding: 4px 10px;
    border-top: 1px solid #ccc;
    background-color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #user-panel select {
    flex: 1;
    margin-left: 8px;
    font-size: 13px;
    padding: 3px;
  }

  /* --- Mobile / portrait mode --- */
  @media (max-width: 768px) and (orientation: portrait) {
    #split-container {
      flex-direction: column;
    }

    #graph-div {
      flex: 0 0 35vh;
      border-right: none;
      border-bottom: 1px solid #ccc;
    }

    #info-container {
      flex: 1;
      height: 65vh;
    }

    #info-panel {
      flex: 1;
      overflow-y: auto;
    }

    #image-wrapper {
      height: 25vh;
      max-height: 40%;
    }

    #user-panel {
      flex: 0 0 35px;
      height: 35px;
    }
  }

  /* --- Landscape tablets/phones --- */
  @media (max-width: 768px) and (orientation: landscape) {
    #split-container {
      flex-direction: row;
    }

    #graph-div {
      flex: 1.3;
    }

    #info-container {
      flex: 1;
      flex-direction: column;
    }

    #info-panel {
      flex: 1;
      overflow-y: auto;
    }

    #user-panel {
      flex: 0 0 35px;
      height: 35px;
    }
  }

  </style>
</head>
<body>
  <div id="split-container">
    <div id="graph-div"></div>
    <div id="info-container">
      <div id="info-panel">
        <h3>Select a node</h3>
        <div id="info-text"></div>
        <div id="image-wrapper"></div>
      </div>
      <div id="user-panel">
        <b>Show progress for:</b>
        <select id="user-select"><option value="">â€” Select user â€”</option></select>
      </div>
    </div>
  </div>

  <script>
  async function main() {
    const base = "https://thatkow.github.io/nucc-progression-map/";
    const cachebust = "?v=" + new Date().getTime();

    // âœ… Load definition.csv
    const defURL = base + "definition.csv" + cachebust;
    const defResp = await fetch(defURL);
    const defText = await defResp.text();
    console.log("âœ… Loaded definition.csv:", defText);

    const rows = defText.trim().split(/\r?\n/).map(r =>
      r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(v => v.replace(/^"|"$/g, "")) || []
    );
    const headers = rows.shift();
    const definition = rows.map(row => Object.fromEntries(row.map((v, i) => [headers[i], v])));
    console.log("âœ… Parsed definition data:", definition);

    // âœ… Load user progress CSV
    const csvURL = base + "user_progress.csv" + cachebust;
    const csvResp = await fetch(csvURL);
    const csvText = await csvResp.text();
    console.log("âœ… Loaded user progress CSV:", csvText);

    const csvRows = csvText.trim().split(/\r?\n/).map(r => r.split(","));
    const csvHeaders = csvRows.shift();
    const users = csvRows.map(r => r[0]);
    const userProgress = Object.fromEntries(
      csvRows.map(r => [r[0], Object.fromEntries(csvHeaders.slice(1).map((c, i) => [c, r[i + 1]]))])
    );

    const container = document.getElementById('graph-div');

    // ðŸ§­ Build nodes
    const nodes = new vis.DataSet(definition.map(n => ({
      id: n.id,
      label: n.id,
      title: n.description,
      color: n.color,
      x: Number(n.x),
      y: Number(n.y),
      fixed: { x: true, y: true },
      category: n.category,
      signoff: n.signoff,
      description: n.description
    })));

    // ðŸ”— Build edges from prereq column
    const edgesArr = [];
    definition.forEach(n => {
      if (n.prereq && n.prereq.trim() !== "") {
        n.prereq.split(";").forEach(p => {
          const prereq = p.trim();
          if (prereq) edgesArr.push({ from: prereq, to: n.id, arrows: "to" });
        });
      }
    });
    const edges = new vis.DataSet(edgesArr);

    const data = { nodes, edges };

    // âš™ï¸ Network options
    const options = {
      physics: { enabled: false },
      interaction: {
        dragNodes: false,
        dragView: true,
        zoomView: true
      },
      edges: { smooth: false, color: "#333" },
      nodes: { shape: "box", borderWidth: 1 }
    };

    const network = new vis.Network(container, data, options);
    network.fit({ animation: false });

    // ðŸŽ¨ Preserve original colors
    const originalColors = {};
    nodes.forEach(n => originalColors[n.id] = n.color);

    // ðŸ‘¥ Populate user dropdown
    const select = document.getElementById('user-select');
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      select.appendChild(opt);
    });

    // ðŸ‘¤ User progress toggle
    select.addEventListener('change', () => {
      const user = select.value;
      const progress = userProgress[user] || {};
      nodes.forEach(n => nodes.update({ id: n.id, color: originalColors[n.id] }));
      if (user) {
        nodes.forEach(n => {
          const completed = progress[n.id];
          if (!completed) nodes.update({ id: n.id, color: "#cccccc" });
        });
      }
    });

    // ðŸ–±ï¸ Node click info & image
    network.on("click", params => {
      if (params.nodes.length) {
        const node = nodes.get(params.nodes[0]);
        const info = document.getElementById('info-text');
        const imagePanel = document.getElementById('image-wrapper');
        info.innerHTML = `
          <h3>${node.id}</h3>
          <b>Category:</b> ${node.category}<br>
          <b>Sign-off:</b> ${node.signoff}<br><br>
          <div style="white-space:pre-line">${node.description}</div>
        `;
        const imgName = encodeURIComponent(node.id.replace(/\s+/g, " ")) + ".png";
        const imgURL = base + "images/" + imgName;
        const testImg = new Image();
        testImg.onload = () => {
          imagePanel.innerHTML = `<img src="${imgURL}" class="preview" alt="${node.id} image">`;
        };
        testImg.onerror = () => {
          imagePanel.innerHTML = "";
        };
        testImg.src = imgURL;
      }
    });
  }

  main();
  </script>
</body>
</html>
