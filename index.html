<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NUCC Progression Map</title>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; }
    #split-container { display: flex; flex-direction: row; height: 100%; width: 100%; }
    #graph-div { flex: 2; border-right: 1px solid #ccc; }
    #info-container { flex: 1; display: flex; flex-direction: column; height: 100%; }
    #info-panel { flex: 1; padding: 10px; overflow-y: auto; background-color: #fafafa; }
    #image-wrapper { text-align: center; margin-top: 10px; }
    img.preview { max-width: 100%; border-radius: 4px; }
    #user-panel { border-top: 1px solid #ccc; padding: 10px; background-color: #fff; }
    select { width: 100%; padding: 5px; }
  </style>
</head>
<body>
  <div id="split-container">
    <div id="graph-div"></div>
    <div id="info-container">
      <div id="info-panel">
        <h3>Select a node</h3>
        <div id="info-text"></div>
        <div id="image-wrapper"></div>
      </div>
      <div id="user-panel">
        <b>Show progress for:</b><br>
        <select id="user-select"><option value="">â€” Select user â€”</option></select>
      </div>
    </div>
  </div>

  <script>
  async function main() {
    const base = "https://thatkow.github.io/nucc-progression-map/";
    const cachebust = "?v=" + new Date().getTime();

    // âœ… Load definition.csv
    const defURL = base + "definition.csv" + cachebust;
    const defResp = await fetch(defURL);
    const defText = await defResp.text();
    console.log("âœ… Loaded definition.csv:", defText);

    // Proper CSV parsing with quoted fields
    const rows = defText.trim().split(/\r?\n/).map(r =>
      r.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)?.map(v => v.replace(/^"|"$/g, "")) || []
    );
    const headers = rows.shift();
    const definition = rows.map(row => Object.fromEntries(row.map((v, i) => [headers[i], v])));
    console.log("âœ… Parsed definition data:", definition);

    // âœ… Load user progress CSV
    const csvURL = base + "user_progress.csv" + cachebust;
    const csvResp = await fetch(csvURL);
    const csvText = await csvResp.text();
    console.log("âœ… Loaded user progress CSV:", csvText);

    const csvRows = csvText.trim().split(/\r?\n/).map(r => r.split(","));
    const csvHeaders = csvRows.shift();
    const users = csvRows.map(r => r[0]);
    const userProgress = Object.fromEntries(
      csvRows.map(r => [r[0], Object.fromEntries(csvHeaders.slice(1).map((c, i) => [c, r[i + 1]]))])
    );
    console.log("âœ… Parsed user progress:", userProgress);

    const container = document.getElementById('graph-div');

    // ðŸ§­ Build nodes
    const nodes = new vis.DataSet(definition.map(n => ({
      id: n.id,
      label: n.id,
      title: n.description,
      color: n.color,
      x: Number(n.x),
      y: Number(n.y),
      fixed: { x: true, y: true },
      category: n.category,
      signoff: n.signoff,
      description: n.description
    })));

    // ðŸ”— Build edges from prereq column
    const edgesArr = [];
    definition.forEach(n => {
      if (n.prereq && n.prereq.trim() !== "") {
        n.prereq.split(";").forEach(p => {
          const prereq = p.trim();
          if (prereq) edgesArr.push({ from: prereq, to: n.id, arrows: "to" });
        });
      }
    });
    const edges = new vis.DataSet(edgesArr);
    console.log("âœ… Built edges:", edgesArr);

    const data = { nodes, edges };

    // âš™ï¸ Network options
    const options = {
      physics: { enabled: false },
      interaction: {
        dragNodes: false,
        dragView: true,
        zoomView: true
      },
      edges: { smooth: false, color: "#333" },
      nodes: { shape: "box", borderWidth: 1 }
    };

    const network = new vis.Network(container, data, options);
    network.fit({ animation: false });

    // ðŸŸ© Preserve original colors
    const originalColors = {};
    nodes.forEach(n => originalColors[n.id] = n.color);

    // ðŸŽ›ï¸ Populate user select
    const select = document.getElementById('user-select');
    users.forEach(u => {
      const opt = document.createElement('option');
      opt.value = u;
      opt.textContent = u;
      select.appendChild(opt);
    });

    // ðŸ‘¤ Highlight user progress (keep colors same, grey others)
    select.addEventListener('change', () => {
      const user = select.value;
      const progress = userProgress[user] || {};

      // Reset all nodes
      nodes.forEach(n => nodes.update({ id: n.id, color: originalColors[n.id] }));

      // Grey out not completed
      if (user) {
        nodes.forEach(n => {
          const completed = progress[n.id];
          if (!completed) nodes.update({ id: n.id, color: "#cccccc" });
        });
      }
    });

    // ðŸ–±ï¸ Node click info + auto-load image from /images/
    network.on("click", params => {
      if (params.nodes.length) {
        const node = nodes.get(params.nodes[0]);
        const info = document.getElementById('info-text');
        const imagePanel = document.getElementById('image-wrapper');
        info.innerHTML = `
          <h3>${node.id}</h3>
          <b>Category:</b> ${node.category}<br>
          <b>Sign-off:</b> ${node.signoff}<br><br>
          <div style="white-space:pre-line">${node.description}</div>
        `;

        // Auto-detect image by node name
        const imgName = encodeURIComponent(node.id.replace(/\s+/g, " ")) + ".png";
        const imgURL = base + "images/" + imgName;
        const testImg = new Image();
        testImg.onload = () => {
          imagePanel.innerHTML = `<img src="${imgURL}" class="preview" alt="${node.id} image">`;
        };
        testImg.onerror = () => {
          imagePanel.innerHTML = "";
        };
        testImg.src = imgURL;
      }
    });
  }

  main();
  </script>


</body>
</html>
