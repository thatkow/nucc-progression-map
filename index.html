<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NUCC Progression Map</title>
  <script src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.css">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; width: 100%; overflow: hidden; font-family: Arial, sans-serif; }
    #split-container { display: flex; height: 100%; width: 100%; }
    #graph-div { flex: 2; border-right: 1px solid #ccc; overflow: hidden; }
    #info-container { flex: 1; display: flex; flex-direction: column; height: 100%; }
    #info-panel { flex: 2; padding: 15px; overflow-y: auto; background-color: #f9f9f9; }
    #user-panel { flex: 0 0 100px; padding: 10px; border-top: 1px solid #ccc; background: #fff; }
    select { width: 100%; font-size: 14px; padding: 4px; margin-top: 6px; }
    #image-wrapper img { max-height: 45vh; width: auto; max-width: 100%; object-fit: contain; border: 1px solid #bbb; border-radius: 4px; background: #fff; }
    #spinner {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); display: flex; align-items: center;
      justify-content: center; font-size: 20px; z-index: 9999;
    }
    @media (max-width: 800px) {
      #split-container { flex-direction: column; }
      #graph-div { flex: 1; height: 33%; border-right: none; border-bottom: 1px solid #ccc; }
      #info-container { flex: 1; }
      #image-wrapper img { max-height: 30vh; }
      #user-panel { flex: 0 0 80px; }
    }
  </style>
</head>
<body>
  <div id="spinner">‚è≥ Loading progression map...</div>
  <div id="split-container" style="display:none;">
    <div id="graph-div"></div>
    <div id="info-container">
      <div id="info-panel">
        <div id="info-text"><h3>Select a node</h3></div>
        <div id="image-wrapper"></div>
      </div>
      <div id="user-panel">
        <b>Show progress for:</b><br>
        <select id="user-select">
          <option value="">‚Äî Select user ‚Äî</option>
        </select>
      </div>
    </div>
  </div>

  <script>
  async function main() {
    const base = "https://thatkow.github.io/nucc-progression-map/";
    const cachebust = "?v=" + new Date().getTime();

    // ‚úÖ Load definition.csv (with cache-bust)
    const defURL = base + "definition.csv" + cachebust;
    const defResp = await fetch(defURL);
    const defText = await defResp.text();
    console.log("‚úÖ Loaded definition.csv:", defText);

    // üîÑ Parse CSV safely (handles quoted fields)
    const parsedDef = Papa.parse(defText, { header: true, skipEmptyLines: true });
    const definition = parsedDef.data;
    console.log("‚úÖ Parsed definition data:", definition);

    // ‚úÖ Build edges from prereq
    const edges = [];
    definition.forEach(row => {
      if (row.prereq && row.prereq.trim() !== "") {
        row.prereq.split(";").forEach(pr => {
          const source = pr.trim();
          if (source) edges.push({ from: source, to: row.id });
        });
      }
    });
    console.log("‚úÖ Built edges:", edges);

    // ‚úÖ Load user progress CSV (with cache-bust)
    const csvURL = base + "user_progress.csv" + cachebust;
    const csvResp = await fetch(csvURL);
    const csvText = await csvResp.text();
    console.log("‚úÖ Loaded user progress CSV:", csvText);

    const parsedUsers = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    const userRows = parsedUsers.data;
    const users = userRows.map(r => r.user);
    console.log("‚úÖ Parsed users:", users);

    const userProgress = {};
    userRows.forEach(row => {
      const uname = row.user;
      userProgress[uname] = {};
      Object.keys(row).forEach(key => {
        if (key !== "user" && row[key]) userProgress[uname][key] = row[key];
      });
    });
    console.log("‚úÖ Parsed user progress:", userProgress);

    // ‚úÖ Build network
    const nodes = new vis.DataSet(definition.map(n => ({
      id: n.id,
      label: n.id,
      title: n.description,
      shape: "box",
      color: n.color,
      x: parseFloat(n.x),
      y: parseFloat(n.y),
      fixed: { x: true, y: true },
      category: n.category,
      signoff: n.signoff,
      imagefile: n.image || "",
      font: { size: 16, face: "arial" }
    })));
    const edgesData = new vis.DataSet(edges);

    const container = document.getElementById("graph-div");
    const data = { nodes, edges: edgesData };
    const options = {
      physics: { enabled: false },
      interaction: {
        dragNodes: false, dragView: false, zoomView: true, selectable: true,
        multiselect: false, navigationButtons: false, keyboard: false
      },
      edges: { smooth: false, arrows: { to: { enabled: true, scaleFactor: 0.8 } }, color: { color: "#333" } },
      nodes: { borderWidth: 1 }
    };
    const network = new vis.Network(container, data, options);

    // ‚úÖ Populate user dropdown
    const sel = document.getElementById("user-select");
    sel.innerHTML += users.map(u => `<option value="${u}">${u}</option>`).join("");

    // ‚úÖ Node click ‚Üí show info
    network.on("click", params => {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        const node = nodes.get(nodeId);
        const info = document.getElementById("info-text");
        const image = document.getElementById("image-wrapper");

        info.innerHTML = `
          <h3>${node.label}</h3>
          <b>Category:</b> ${node.category}<br>
          <b>Sign-off:</b> ${node.signoff}<br><br>
          <div style="white-space:pre-wrap;">${node.title}</div><br>
        `;
        image.innerHTML = node.imagefile ? `<img src="${node.imagefile}" alt="${node.label}">` : "";
      }
    });

    // ‚úÖ User select ‚Üí highlight progress
    sel.addEventListener("change", e => {
      const user = e.target.value;
      const allNodes = nodes.get();
      allNodes.forEach(n => {
        const completed = userProgress[user] && userProgress[user][n.id];
        nodes.update({
          id: n.id,
          color: completed ? "#7ae582" : "#dddddd",
          title: completed ? `${n.id}\nCompleted: ${completed}` : `${n.id}\nNot yet completed`
        });
      });
    });

    document.getElementById("spinner").style.display = "none";
    document.getElementById("split-container").style.display = "flex";
  }

  main();
  </script>
</body>
</html>
