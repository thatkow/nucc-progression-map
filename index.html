<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NUCC Progression Map</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/standalone/umd/vis-network.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <style>
    body, html {
      margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif;
    }
    #split-container {
      display: flex; height: 100%; width: 100%;
    }
    #graph-div {
      flex: 2; border-right: 1px solid #ccc;
    }
    #info-container {
      flex: 1; display: flex; flex-direction: column; height: 100%;
    }
    #info-panel {
      flex: 2; padding: 15px; overflow-y: auto; background-color: #f9f9f9;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    #info-text {
      flex: 1 1 auto; overflow-y: auto;
    }
    #image-wrapper {
      flex: 0 0 auto; display: flex; justify-content: center; align-items: center; height: 50vh;
    }
    img.preview {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      border-radius: 4px;
      border: 1px solid #bbb;
      background-color: #fff;
    }
    #user-panel {
      flex: 0 0 140px; padding: 15px; border-top: 1px solid #ccc; background-color: #fff;
    }
    select {
      width: 100%; font-size: 14px; padding: 6px; margin-top: 6px;
    }
  </style>
</head>
<body>
<div id="split-container">
  <div id="graph-div"></div>
  <div id="info-container">
    <div id="info-panel">
      <div id="info-text">
        <h3>Select a node</h3>
        <p>Click a node to see details and image.</p>
      </div>
      <div id="image-wrapper"></div>
    </div>
    <div id="user-panel">
      <b>Show progress for:</b><br>
      <select id="user-select">
        <option value="">— Select user —</option>
        <option value="Alice">Alice</option>
        <option value="Ben">Ben</option>
        <option value="Charlie">Charlie</option>
      </select>
    </div>
  </div>
</div>

<script>
async function loadGraph() {
  // Load GraphML
  const graphText = await fetch("progression.graphml").then(r => r.text());
  const parser = new DOMParser();
  const xml = parser.parseFromString(graphText, "application/xml");

  const nodes = [];
  const edges = [];
  const userProgress = {
    Alice: ["Beginner Vertical Caver", "Vertical Caver", "Beginner Rigger"],
    Ben: ["Beginner Vertical Caver", "Canyoner", "Canyon Leader"],
    Charlie: ["Beginner Vertical Caver", "Vertical Caver", "Rescue 1", "Vertical Cave Leader"]
  };

  // Parse layout JSON
  const layout = await fetch("progression_layout.json").then(r => r.json());

  // Parse nodes
  xml.querySelectorAll("node").forEach((n, i) => {
    const id = n.getAttribute("id");
    const data = {};
    n.querySelectorAll("data").forEach(d => {
      data[d.getAttribute("key")] = d.textContent;
    });

    const pos = layout[id] || {x: 0, y: 0};
    nodes.push({
      id,
      label: id,
      x: pos.x,
      y: -pos.y,
      fixed: true,
      color: data.color || "#cccccc",
      category: data.category || "Other",
      signoff: data.signoff || "",
      description: data.description || ""
    });
  });

  // Parse edges
  xml.querySelectorAll("edge").forEach(e => {
    edges.push({ from: e.getAttribute("source"), to: e.getAttribute("target") });
  });

  // Build network
  const container = document.getElementById("graph-div");
  const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
  const options = {
    physics: false,
    interaction: { dragNodes: false, dragView: false, zoomView: false },
    edges: { smooth: false, arrows: { to: { enabled: true, scaleFactor: 0.8 } }, color: "#333" },
    nodes: { shape: "box", borderWidth: 1 }
  };
  const network = new vis.Network(container, data, options);

  const infoText = document.getElementById("info-text");
  const imageWrapper = document.getElementById("image-wrapper");

  // On node click
  network.on("click", function (params) {
    if (params.nodes.length > 0) {
      const id = params.nodes[0];
      const node = data.nodes.get(id);
      const safeName = node.label.replace(/[\\/:"*?<>|]/g, "_");
      const imgPath = `images/${safeName}.png`;

      fetch(imgPath, { method: "HEAD" })
        .then(r => {
          if (r.ok) {
            imageWrapper.innerHTML = `<img src="${imgPath}" class="preview" alt="${node.label} image">`;
          } else {
            imageWrapper.innerHTML = "";
          }
        })
        .catch(() => imageWrapper.innerHTML = "");

      infoText.innerHTML = `
        <h3>${node.label}</h3>
        <b>Category:</b> ${node.category}<br>
        <b>Sign-off:</b> ${node.signoff}<br><br>
        <div style="white-space:pre-wrap;">${node.description}</div>
      `;
    }
  });

  // User select coloring
  document.getElementById("user-select").addEventListener("change", function () {
    const user = this.value;
    data.nodes.forEach(n => {
      if (!user) {
        data.nodes.update({ id: n.id, color: n.color });
      } else if (userProgress[user]?.includes(n.label)) {
        data.nodes.update({ id: n.id, color: "#8f8" }); // green for completed
      } else {
        data.nodes.update({ id: n.id, color: "#ddd" });
      }
    });
  });
}

loadGraph();
</script>
</body>
</html>
