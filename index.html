<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NUCC Progression Graph</title>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/styles/vis-network.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
  #split-container { display:flex;height:100vh;width:100%; }
  #graph-div { flex:2;border-right:1px solid #ccc;overflow:hidden; }
  #info-container { flex:1;display:flex;flex-direction:column;height:100%;overflow:hidden; }
  #info-panel { flex:1;overflow-y:auto;padding:15px;background-color:#f9f9f9; }
  #image-wrapper { flex:0 0 auto;display:flex;justify-content:center;align-items:center;height:50vh; }
  img.preview { max-width:100%;max-height:100%;object-fit:contain;border:1px solid #bbb;border-radius:4px;background-color:#fff; }
  #user-panel { flex:0 0 40px;padding:4px 10px;border-top:1px solid #ccc;background-color:#fff;display:flex;align-items:center;justify-content:space-between; }
  #user-panel select { flex:1;margin-left:8px;font-size:13px;padding:3px; }
  @media (max-width:768px) and (orientation:portrait) {
    #split-container { flex-direction:column; }
    #graph-div { flex:0 0 33vh;border-right:none;border-bottom:1px solid #ccc; }
    #info-container { flex:1;height:67vh;overflow:hidden; }
  }
  </style>
</head>

<body>
  <div id="split-container">
    <div id="graph-div"><div id="spinner">Loading data...</div></div>
    <div id="info-container">
      <div id="info-panel"><div id="info-text"><h3>Select a skill</h3><p>Click a skill to load details!</p></div><div id="image-wrapper"></div></div>
      <div id="user-panel"><select id="user-select"><option value="">— Select user —</option></select></div>
    </div>
  </div>

<script>
async function main() {
  const base = "https://thatkow.github.io/nucc-progression-map/";
  const cachebust = "?v=" + new Date().getTime();

  // ✅ Load and parse definition.csv (quoted-safe)
  const defURL = base + "definition.csv" + cachebust;
  const defResp = await fetch(defURL);
  const defText = await defResp.text();
  const defParsed = Papa.parse(defText, { header: true, skipEmptyLines: true });
  const definition = defParsed.data;
  console.log("✅ Parsed definition rows:", definition);

  // ✅ Load and parse user_progress.csv
  const csvURL = base + "user_progress.csv" + cachebust;
  const csvResp = await fetch(csvURL);
  const csvText = await csvResp.text();
  const userParsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
  const userRows = userParsed.data;
  console.log("✅ Parsed user progress rows:", userRows);

  // Build nodes/edges
  const nodes = new vis.DataSet();
  const edges = new vis.DataSet();
  definition.forEach(node => {
    const id = node.Name || node.id;
    const imgPath = "images/" + encodeURIComponent(id) + ".png";
    nodes.add({
      id,
      label: id,
      title: `${id}\nCategory: ${node.category || ""}\nSign-off: ${node.signoff || ""}`,
      category: node.category,
      signoff: node.signoff,
      description: node.description,
      shape: "box",
      color: node.color || "#cccccc",
      fixed: { x: true, y: true },
      x: parseFloat(node.x || 0),
      y: parseFloat(node.y || 0),
      imagefile: imgPath
    });
    if (node.prereq) {
      node.prereq.split(";").forEach(pr => {
        if (pr.trim()) edges.add({ from: pr.trim(), to: id, arrows: "to" });
      });
    }
  });

  // Build user progress object
  const userProgress = {};
  userRows.forEach(row => {
    const user = row.user;
    userProgress[user] = {};
    Object.entries(row).forEach(([skill, date]) => {
      if (skill !== "user" && date && date.trim() !== "")
        userProgress[user][skill] = date;
    });
  });

  document.getElementById("spinner").style.display = "none";
  const network = new vis.Network(document.getElementById("graph-div"), { nodes, edges }, {
    physics: { enabled: false },
    interaction: { dragNodes: false, zoomView: true },
    edges: { smooth: false, arrows: { to: { enabled: true } } }
  });

  const select = document.getElementById("user-select");
  Object.keys(userProgress).forEach(u => {
    const opt = document.createElement("option");
    opt.value = u; opt.textContent = u; select.appendChild(opt);
  });

  const originalColors = {};
  nodes.get().forEach(n => originalColors[n.id] = n.color);
  select.addEventListener("change", function() {
    const user = this.value;
    nodes.get().forEach(n => {
      const origColor = originalColors[n.id];
      if (!user) nodes.update({ id: n.id, color: origColor });
      else if (userProgress[user]?.[n.id])
        nodes.update({ id: n.id, color: origColor });
      else nodes.update({ id: n.id, color: "#dddddd" });
    });
  });

  network.on("click", function (params) {
    if (params.nodes.length > 0) {
      const node = nodes.get(params.nodes[0]);
      const imgTag = node.imagefile ? `<img src='${node.imagefile}' class='preview' alt='${node.label} image'>` : '';
      document.getElementById("info-text").innerHTML = `
        <h3>${node.label}</h3>
        <b>Category:</b> ${node.category}<br>
        <b>Sign-off:</b> ${node.signoff}<br><br>
        <div style="white-space:pre-wrap;">${node.description}</div>`;
      document.getElementById("image-wrapper").innerHTML = imgTag;
    }
  });
}
document.addEventListener("DOMContentLoaded", main);
</script>
</body>
</html>
