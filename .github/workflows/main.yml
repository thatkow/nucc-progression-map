name: üîÑ Sync Google Sheets to CSVs

on:
  schedule:
    - cron: "* * * * *"   # every minute
  workflow_dispatch:       # allow manual trigger

permissions:
  contents: write          # ‚úÖ required for pushing commits
  actions: read

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: üì• Download Google Sheets as CSV when changed
        run: |
          set -euo pipefail

          check_and_download() {
            local file_id="$1"
            local output="$2"
            local export_url="https://docs.google.com/spreadsheets/d/${file_id}/export?format=csv"
            local metadata_url="https://www.googleapis.com/drive/v3/files/${file_id}?fields=md5Checksum"
            local remote_md5=""
            local local_md5=""

            echo "üîç Checking ${output}..."
            if ! remote_md5=$(curl -fsSL "${metadata_url}" | python -c 'import sys, json; print(json.load(sys.stdin).get("md5Checksum", ""))'); then
              remote_md5=""
            fi

            if [ -z "${remote_md5}" ]; then
              echo "‚ö†Ô∏è Unable to read remote checksum for ${output}; downloading to ensure freshness."
            elif [ -f "${output}" ]; then
              local_md5=$(md5sum "${output}" | awk '{print $1}')
              if [ "${remote_md5}" = "${local_md5}" ]; then
                echo "‚ÑπÔ∏è No changes detected for ${output}; skipping download."
                return
              fi
            fi

            echo "‚¨áÔ∏è Downloading ${output}..."
            curl -fsSL "${export_url}" -o "${output}.tmp"
            mv "${output}.tmp" "${output}"
            echo "‚úÖ Updated ${output}"
          }

          check_and_download "1TiKDHGDLdDtzuPecKuGMR_Bh_nGs9FKKw75IjXQ43YI" "definition.csv"
          check_and_download "1jUTLoRPed6HDuUb9cCZXaPJ9GRIjEfXpbYd63jPk32I" "user_progress.csv"

          echo "‚úÖ Sync step complete."

      - name: üßπ Commit and push updates
        run: |
          git add definition.csv user_progress.csv
          if git diff --cached --quiet; then
            echo "‚úÖ No changes detected, skipping commit."
          else
            git commit -m "üîÑ Auto-update from Google Sheets"
            git push
          fi

